<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated GPS Tracker with OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #map-container {
            flex: 1;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #automation-panel {
            width: 350px;
            background-color: #ffffff;
            padding: 1rem;
            overflow-y: auto;
            border-left: 1px solid #e2e8f0;
            transition: width 0.3s ease;
        }
        #automation-panel.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        #video-container {
            position: relative;
            background-color: #000;
        }
        #video, #selection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
        }
        #selection-canvas {
            cursor: crosshair;
        }
        .message-box {
            display: none;
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            z-index: 2000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #ocr-status {
            min-height: 50px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">
        <div class="bg-white p-2 border-b shadow-sm flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">Automated GPS Tracker</h1>
            <div>
                 <button id="toggle-automation-panel" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">Show Automation Panel</button>
            </div>
        </div>

        <div id="main-content">
            <div id="map-container">
                <div id="map"></div>
                <div id="message-box"><span id="message-text"></span></div>
            </div>

            <div id="automation-panel" class="hidden">
                <div class="space-y-4">
                    <h2 class="text-lg font-bold border-b pb-2">Automation Controls</h2>
                    
                    <div>
                        <button id="start-webcam-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">1. Start Webcam</button>
                    </div>

                    <div id="video-wrapper" class="hidden">
                        <div id="video-container" class="w-full aspect-video rounded-md overflow-hidden">
                            <video id="video" playsinline autoplay muted></video>
                            <canvas id="selection-canvas"></canvas>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Click and drag on the video above to select the area with the GPS coordinates.</p>
                    </div>
                    
                    <div id="tracking-controls" class="hidden">
                        <div>
                            <label for="interval" class="block text-sm font-medium text-gray-700">Capture Interval (seconds)</label>
                            <input type="number" id="interval" value="5" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <button id="start-tracking-btn" class="w-full mt-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>2. Start Tracking</button>
                        <button id="stop-tracking-btn" class="w-full mt-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 hidden">Stop Tracking</button>
                    </div>

                    <div>
                        <h3 class="font-bold">OCR Status</h3>
                        <div id="ocr-status" class="mt-1 p-2 bg-gray-100 rounded-md text-sm text-gray-700 overflow-x-auto">
                            <p>OCR is idle.</p>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-bold">Path Points</h3>
                        <div id="coord-list" class="mt-1 p-2 bg-gray-100 rounded-md text-sm max-h-48 overflow-y-auto">
                           <ul id="point-list-ul"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let map;
        let polyline;
        let markers = [];
        const pathCoordinates = [];
        let trackingIntervalId = null;
        let selectionRect = {};
        let isSelecting = false;

        // --- DOM Elements ---
        const video = document.getElementById('video');
        const selectionCanvas = document.getElementById('selection-canvas');
        const ctx = selectionCanvas.getContext('2d');
        const ocrStatusEl = document.getElementById('ocr-status');
        const startWebcamBtn = document.getElementById('start-webcam-btn');
        const startTrackingBtn = document.getElementById('start-tracking-btn');
        const stopTrackingBtn = document.getElementById('stop-tracking-btn');
        const intervalInput = document.getElementById('interval');
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
        });

        function initMap() {
            map = L.map('map').setView([48.3794, 31.1656], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            polyline = L.polyline(pathCoordinates, { color: 'red' }).addTo(map);
        }

        function setupEventListeners() {
            document.getElementById('toggle-automation-panel').addEventListener('click', toggleAutomationPanel);
            startWebcamBtn.addEventListener('click', startWebcam);
            selectionCanvas.addEventListener('mousedown', startSelection);
            selectionCanvas.addEventListener('mousemove', drawSelection);
            selectionCanvas.addEventListener('mouseup', endSelection);
            selectionCanvas.addEventListener('mouseleave', endSelection);
            startTrackingBtn.addEventListener('click', startTracking);
            stopTrackingBtn.addEventListener('click', stopTracking);
        }

        // --- UI Functions ---
        function toggleAutomationPanel() {
            const panel = document.getElementById('automation-panel');
            panel.classList.toggle('hidden');
            this.textContent = panel.classList.contains('hidden') ? 'Show Automation Panel' : 'Hide Automation Panel';
        }

        function showMessage(text, isError = true) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = text;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#10b981';
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);
        }

        function updateOcrStatus(message, isLoading = false) {
             ocrStatusEl.innerHTML = isLoading 
                ? `<div class="flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${message}</span></div>`
                : `<p>${message}</p>`;
        }

        // --- Automation Core ---
        async function startWebcam() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showMessage("getUserMedia() is not supported by your browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    selectionCanvas.width = video.videoWidth;
                    selectionCanvas.height = video.videoHeight;
                    document.getElementById('video-wrapper').classList.remove('hidden');
                    document.getElementById('tracking-controls').classList.remove('hidden');
                    startWebcamBtn.textContent = "Webcam Active";
                    startWebcamBtn.disabled = true;
                });
            } catch (err) {
                showMessage(`Error accessing webcam: ${err.name}`);
            }
        }

        function startSelection(e) {
            isSelecting = true;
            selectionRect.startX = e.offsetX;
            selectionRect.startY = e.offsetY;
        }

        function drawSelection(e) {
            if (!isSelecting) return;
            const x = e.offsetX;
            const y = e.offsetY;
            ctx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(selectionRect.startX, selectionRect.startY, x - selectionRect.startX, y - selectionRect.startY);
        }

        function endSelection(e) {
            if (!isSelecting) return;
            isSelecting = false;
            selectionRect.w = e.offsetX - selectionRect.startX;
            selectionRect.h = e.offsetY - selectionRect.startY;

            if (selectionRect.w < 10 || selectionRect.h < 10) {
                 ctx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
                 selectionRect = {};
                 startTrackingBtn.disabled = true;
            } else {
                 startTrackingBtn.disabled = false;
                 showMessage("Region selected. Ready to start tracking.", false);
            }
        }

        function startTracking() {
            if (!selectionRect.w || !selectionRect.h) {
                showMessage("Please select a region on the video first.");
                return;
            }
            const interval = parseInt(intervalInput.value, 10) * 1000;
            if (isNaN(interval) || interval < 1000) {
                showMessage("Please set a valid interval of at least 1 second.");
                return;
            }

            trackingIntervalId = setInterval(performOcr, interval);
            
            startTrackingBtn.classList.add('hidden');
            stopTrackingBtn.classList.remove('hidden');
            showMessage(`Tracking started. Capturing every ${interval/1000} seconds.`, false);
            performOcr(); // Perform one immediately
        }

        function stopTracking() {
            if (trackingIntervalId) {
                clearInterval(trackingIntervalId);
                trackingIntervalId = null;
            }
            startTrackingBtn.classList.remove('hidden');
            stopTrackingBtn.classList.add('hidden');
            updateOcrStatus("Tracking stopped.");
        }

        async function performOcr() {
            if (!selectionRect.w || !selectionRect.h) return;

            // Create a temporary canvas to hold the cropped image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = selectionRect.w;
            tempCanvas.height = selectionRect.h;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw the selected part of the video onto the temporary canvas
            tempCtx.drawImage(video, selectionRect.startX, selectionRect.startY, selectionRect.w, selectionRect.h, 0, 0, selectionRect.w, selectionRect.h);

            updateOcrStatus("Recognizing text...", true);
            
            try {
                const result = await Tesseract.recognize(
                    tempCanvas,
                    'eng',
                    { 
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                updateOcrStatus(`Recognizing... (${(m.progress * 100).toFixed(0)}%)`, true);
                            }
                        },
                        tessedit_char_whitelist: '0123456789.,- ' // Whitelist characters for better accuracy
                    }
                );
                
                const text = result.data.text;
                updateOcrStatus(`Recognized: "${text.trim()}"`);
                parseAndAddPoint(text);

            } catch (error) {
                console.error(error);
                updateOcrStatus(`OCR Error: ${error.message}`);
            }
        }

        // --- Map Functions ---
        function parseAndAddPoint(text) {
            // Regex to find two numbers (integer or float, positive or negative) separated by a comma
            const match = text.replace(/(\r\n|\n|\r)/gm, " ").match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
            
            if (!match) {
                updateOcrStatus(`Recognized: "${text.trim()}" <br><b>Could not find valid coordinates.</b>`);
                return;
            }

            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);

            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                 updateOcrStatus(`Recognized: "${text.trim()}" <br><b>Parsed invalid lat/lng values.</b>`);
                return;
            }

            const position = [lat, lng];
            const marker = L.marker(position).addTo(map)
                .bindPopup(`Point ${markers.length + 1}: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            
            markers.push(marker);
            polyline.addLatLng(position);
            updatePointList(lat, lng);
            map.panTo(position);
        }

        function updatePointList(lat, lng) {
            const listUl = document.getElementById('point-list-ul');
            const listItem = document.createElement('li');
            listItem.className = 'text-gray-800'
            listItem.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            listUl.prepend(listItem); // Add new points to the top
        }

    </script>
</body>
</html>
