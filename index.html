<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated & Manual GPS Tracker with OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #main-content {
            flex: 1;
            position: relative; /* Needed for absolute positioning of the side panel */
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #side-panel {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 350px;
            max-width: 90vw;
            background-color: #ffffff;
            padding: 1rem;
            overflow-y: auto;
            border-left: 1px solid #e2e8f0;
            z-index: 1200; /* High z-index to be on top */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }
        #side-panel.open {
            transform: translateX(0);
        }
        #video-container {
            position: relative;
            background-color: #2d3748; /* Dark background for test mode visibility */
        }
        /* All video/canvas layers are positioned on top of each other */
        #video, #test-mode-canvas, #selection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
        }
        #selection-canvas {
            cursor: crosshair;
            z-index: 10; /* Ensure selection is on top */
        }
        .message-box {
            display: none;
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            z-index: 2000; /* Highest z-index */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #ocr-status {
            min-height: 50px;
        }
        .tab-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Custom style for the numbered markers */
        .number-marker {
            background-color: #dc2626; /* Red-600 */
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            line-height: 22px; /* Vertically center the number */
            border: 1px solid #fee2e2; /* Red-100 */
            width: 22px;
            height: 22px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">
        <header class="bg-white p-2 border-b shadow-sm flex items-center justify-between z-10">
            <h1 class="text-xl font-bold text-gray-800">GPS Tracker</h1>
            <div>
                 <button id="toggle-side-panel" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">Show Panel</button>
            </div>
        </header>

        <main id="main-content">
            <div id="map"></div>
            <div id="message-box"><span id="message-text"></span></div>

            <aside id="side-panel">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex flex-grow">
                        <button id="manual-tab-btn" class="tab-btn active rounded-l-md">Manual</button>
                        <button id="auto-tab-btn" class="tab-btn rounded-r-md">Automation</button>
                    </div>
                    <button id="close-panel-btn" class="ml-2 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                </div>

                <!-- Manual Controls -->
                <div id="manual-controls">
                    <div class="space-y-4">
                        <h2 class="text-lg font-bold border-b pb-2">Manual Controls</h2>
                        <div>
                            <label for="coords-input" class="block text-sm font-medium text-gray-700">Coordinates (Lat, Lng)</label>
                            <input type="text" id="coords-input" placeholder="Click map or type coords" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <button id="add-point-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Add Point</button>
                        <button id="get-location-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Get My Location</button>
                    </div>
                </div>

                <!-- Automation Controls -->
                <div id="automation-controls" class="hidden">
                     <div class="space-y-4">
                        <h2 class="text-lg font-bold border-b pb-2">Automation Controls</h2>
                        <div id="automation-start-buttons" class="space-y-2">
                            <button id="start-webcam-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">1. Start Webcam</button>
                            <button id="start-test-mode-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700">Start Test Mode</button>
                        </div>
                        <div id="video-wrapper" class="hidden">
                            <div id="video-container" class="w-full aspect-video rounded-md overflow-hidden">
                                <video id="video" playsinline autoplay muted></video>
                                <canvas id="test-mode-canvas"></canvas>
                                <canvas id="selection-canvas"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Click and drag to select the coordinates area.</p>
                        </div>
                        <div id="tracking-controls" class="hidden">
                            <div class="pt-4 border-t">
                                <h3 class="font-bold">My Location</h3>
                                <p class="text-sm text-gray-500 mb-2">Highlight your position on the map.</p>
                                <div class="space-y-2">
                                    <input type="text" id="auto-location-input" placeholder="Lat, Lng (optional)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <button id="set-auto-location-btn" class="w-full px-4 py-2 bg-gray-500 text-white font-semibold rounded-md hover:bg-gray-600">Set Manual Location</button>
                                    <button id="find-auto-location-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Find My Location (API)</button>
                                </div>
                            </div>
                            <div class="pt-4 border-t">
                                <label for="interval" class="block text-sm font-medium text-gray-700">Capture Interval (seconds)</label>
                                <input type="number" id="interval" value="5" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <button id="start-tracking-btn" class="w-full mt-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>2. Start Tracking</button>
                            <button id="stop-tracking-btn" class="w-full mt-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 hidden">Stop Tracking</button>
                        </div>
                        <div>
                            <h3 class="font-bold">OCR Status</h3>
                            <div id="ocr-status" class="mt-1 p-2 bg-gray-100 rounded-md text-sm text-gray-700 overflow-x-auto"><p>OCR is idle.</p></div>
                        </div>
                    </div>
                </div>
                
                <!-- Shared Elements -->
                <div class="mt-4 pt-4 border-t">
                    <h3 class="font-bold">Path Points</h3>
                    <div id="coord-list" class="mt-1 p-2 bg-gray-100 rounded-md text-sm max-h-48 overflow-y-auto">
                       <ul id="point-list-ul"></ul>
                    </div>
                    <button id="clear-path-btn" class="w-full mt-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Clear Path</button>
                </div>
            </aside>
        </main>
    </div>

    <script>
        let map, polyline, trackingIntervalId, myLocationMarker, testModeIntervalId;
        let markers = [];
        const pathCoordinates = [];
        let selectionRect = {};
        let isSelecting = false;
        let isTestMode = false;

        const video = document.getElementById('video');
        const testModeCanvas = document.getElementById('test-mode-canvas');
        const selectionCanvas = document.getElementById('selection-canvas');
        const testCtx = testModeCanvas.getContext('2d');
        const selectionCtx = selectionCanvas.getContext('2d');
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
        });

        function initMap() {
            map = L.map('map').setView([50.45, 30.52], 6); // Center on Kyiv
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            polyline = L.polyline(pathCoordinates, { color: 'red' }).addTo(map);
        }

        function setupEventListeners() {
            // Panel and Tabs
            document.getElementById('toggle-side-panel').addEventListener('click', toggleSidePanel);
            document.getElementById('close-panel-btn').addEventListener('click', toggleSidePanel);
            document.getElementById('manual-tab-btn').addEventListener('click', () => switchTab('manual'));
            document.getElementById('auto-tab-btn').addEventListener('click', () => switchTab('auto'));

            // Manual Controls
            document.getElementById('add-point-btn').addEventListener('click', addManualPoint);
            document.getElementById('get-location-btn').addEventListener('click', findAndSetMyLocation);
            document.getElementById('clear-path-btn').addEventListener('click', clearMap);
            map.on('click', onMapClick);

            // Automation Controls
            document.getElementById('start-webcam-btn').addEventListener('click', startWebcam);
            document.getElementById('start-test-mode-btn').addEventListener('click', startTestMode);
            document.getElementById('set-auto-location-btn').addEventListener('click', setMyLocationFromInput);
            document.getElementById('find-auto-location-btn').addEventListener('click', findAndSetMyLocation);
            selectionCanvas.addEventListener('mousedown', startSelection);
            selectionCanvas.addEventListener('mousemove', drawSelection);
            selectionCanvas.addEventListener('mouseup', endSelection);
            selectionCanvas.addEventListener('mouseleave', endSelection);
            document.getElementById('start-tracking-btn').addEventListener('click', startTracking);
            document.getElementById('stop-tracking-btn').addEventListener('click', stopTracking);
        }

        // --- UI & Tab Functions ---
        function toggleSidePanel() {
            document.getElementById('side-panel').classList.toggle('open');
        }

        function switchTab(tab) {
            const manualControls = document.getElementById('manual-controls');
            const autoControls = document.getElementById('automation-controls');
            const manualBtn = document.getElementById('manual-tab-btn');
            const autoBtn = document.getElementById('auto-tab-btn');

            if (tab === 'manual') {
                manualControls.classList.remove('hidden');
                autoControls.classList.add('hidden');
                manualBtn.classList.add('active');
                autoBtn.classList.remove('active');
            } else {
                manualControls.classList.add('hidden');
                autoControls.classList.remove('hidden');
                manualBtn.classList.remove('active');
                autoBtn.classList.add('active');
            }
        }

        function showMessage(text, isError = true) {
            const msgBox = document.getElementById('message-box');
            msgBox.querySelector('span').textContent = text;
            msgBox.style.backgroundColor = isError ? '#ef4444' : '#10b981';
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.display = 'none'; }, 4000);
        }

        // --- My Location Functions ---
        function setMyLocation(lat, lng) {
            if (myLocationMarker) {
                map.removeLayer(myLocationMarker);
            }
            // Create a custom blue icon for "My Location"
            const blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            myLocationMarker = L.marker([lat, lng], { icon: blueIcon }).addTo(map)
                .bindPopup("<b>My Location</b>").openPopup();
            map.panTo([lat, lng]);
        }

        function findAndSetMyLocation() {
            if (!navigator.geolocation) return showMessage("Geolocation is not supported by this browser.");
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                setMyLocation(latitude, longitude);
                // Also populate the manual input for convenience
                document.getElementById('coords-input').value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            }, () => showMessage("Could not get your location."));
        }
        
        function setMyLocationFromInput() {
            const coordsString = document.getElementById('auto-location-input').value;
            if (!coordsString) return showMessage("Please enter coordinates for your location.");
            const parts = coordsString.split(',').map(p => parseFloat(p.trim()));
            if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return showMessage("Invalid format. Please use 'latitude, longitude'.");
            setMyLocation(parts[0], parts[1]);
        }


        // --- Manual Mode Functions ---
        function onMapClick(e) {
            const { lat, lng } = e.latlng;
            document.getElementById('coords-input').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            if (!document.getElementById('side-panel').classList.contains('open')) {
                toggleSidePanel();
            }
        }

        function addManualPoint() {
            const coordsString = document.getElementById('coords-input').value;
            if (!coordsString) return showMessage("Please enter coordinates or click the map.");
            const parts = coordsString.split(',').map(p => parseFloat(p.trim()));
            if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return showMessage("Invalid format. Please use 'latitude, longitude'.");
            createAndAddPoint(parts[0], parts[1]);
            document.getElementById('coords-input').value = '';
        }

        // --- Automation Mode Functions ---
        function updateOcrStatus(message, isLoading = false) {
             document.getElementById('ocr-status').innerHTML = isLoading 
                ? `<div class="flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${message}</span></div>`
                : `<p>${message}</p>`;
        }
        
        async function startWebcam() {
            isTestMode = false;
            video.style.display = 'block';
            testModeCanvas.style.display = 'none';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    selectionCanvas.width = video.videoWidth;
                    selectionCanvas.height = video.videoHeight;
                    document.getElementById('video-wrapper').classList.remove('hidden');
                    document.getElementById('tracking-controls').classList.remove('hidden');
                    document.getElementById('automation-start-buttons').classList.add('hidden');
                };
            } catch (err) { showMessage(`Error accessing webcam: ${err.name}`); }
        }

        function startTestMode() {
            isTestMode = true;
            video.style.display = 'none';
            testModeCanvas.style.display = 'block';
            document.getElementById('video-wrapper').classList.remove('hidden');
            document.getElementById('tracking-controls').classList.remove('hidden');
            document.getElementById('automation-start-buttons').classList.add('hidden');
            
            testModeCanvas.width = 320;
            testModeCanvas.height = 180;
            selectionCanvas.width = 320;
            selectionCanvas.height = 180;

            let lat = 50.2323131;
            let lng = 32.2323232;

            testModeIntervalId = setInterval(() => {
                lat += (Math.random() - 0.5) * 0.001;
                lng += (Math.random() - 0.5) * 0.001;
                
                testCtx.clearRect(0, 0, testModeCanvas.width, testModeCanvas.height);
                testCtx.fillStyle = '#2d3748';
                testCtx.fillRect(0, 0, testModeCanvas.width, testModeCanvas.height);
                
                testCtx.font = '20px monospace';
                testCtx.fillStyle = 'white';
                testCtx.fillText(lat.toFixed(8), 20, 50);
                testCtx.fillText(lng.toFixed(8), 20, 80);
            }, 1000);
        }
        
        function getMousePos(evt) {
            const rect = selectionCanvas.getBoundingClientRect();
            const scaleX = selectionCanvas.width / rect.width;
            const scaleY = selectionCanvas.height / rect.height;

            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }

        function startSelection(e) { 
            const pos = getMousePos(e);
            isSelecting = true; 
            selectionRect = { startX: pos.x, startY: pos.y }; 
        }
        
        function drawSelection(e) {
            if (!isSelecting) return;
            const pos = getMousePos(e);
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            selectionCtx.strokeStyle = 'red';
            selectionCtx.lineWidth = 2;
            selectionCtx.strokeRect(selectionRect.startX, selectionRect.startY, pos.x - selectionRect.startX, pos.y - selectionRect.startY);
        }

        function endSelection(e) {
            if (!isSelecting) return;
            const pos = getMousePos(e);
            isSelecting = false;
            selectionRect.w = pos.x - selectionRect.startX;
            selectionRect.h = pos.y - selectionRect.startY;
            const startTrackingBtn = document.getElementById('start-tracking-btn');
            if (Math.abs(selectionRect.w) < 10 || Math.abs(selectionRect.h) < 10) {
                 selectionRect = {};
                 startTrackingBtn.disabled = true;
                 selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            } else {
                 startTrackingBtn.disabled = false;
                 showMessage("Region selected. Ready to start tracking.", false);
            }
        }

        function startTracking() {
            const interval = parseInt(document.getElementById('interval').value, 10) * 1000;
            trackingIntervalId = setInterval(performOcr, interval);
            document.getElementById('start-tracking-btn').classList.add('hidden');
            document.getElementById('stop-tracking-btn').classList.remove('hidden');
            showMessage(`Tracking started. Capturing every ${interval/1000}s.`, false);
            performOcr();
        }

        function stopTracking() {
            if (trackingIntervalId) clearInterval(trackingIntervalId);
            if (testModeIntervalId) clearInterval(testModeIntervalId);
            trackingIntervalId = null;
            testModeIntervalId = null;

            document.getElementById('start-tracking-btn').classList.remove('hidden');
            document.getElementById('stop-tracking-btn').classList.add('hidden');
            document.getElementById('automation-start-buttons').classList.remove('hidden');
            document.getElementById('video-wrapper').classList.add('hidden');
            document.getElementById('tracking-controls').classList.add('hidden');
            
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            video.style.display = 'block';
            testModeCanvas.style.display = 'none';
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);

            updateOcrStatus("Tracking stopped.");
        }

        async function performOcr() {
            if (!selectionRect.w || !selectionRect.h) return;
            const sourceElement = isTestMode ? testModeCanvas : video;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = Math.abs(selectionRect.w);
            tempCanvas.height = Math.abs(selectionRect.h);
            const sx = selectionRect.w > 0 ? selectionRect.startX : selectionRect.startX + selectionRect.w;
            const sy = selectionRect.h > 0 ? selectionRect.startY : selectionRect.startY + selectionRect.h;
            tempCanvas.getContext('2d').drawImage(sourceElement, sx, sy, Math.abs(selectionRect.w), Math.abs(selectionRect.h), 0, 0, Math.abs(selectionRect.w), Math.abs(selectionRect.h));
            
            updateOcrStatus("Recognizing...", true);
            try {
                const { data: { text } } = await Tesseract.recognize(tempCanvas, 'eng', { tessedit_char_whitelist: '0123456789.,- ' });
                updateOcrStatus(`Recognized: "${text.trim()}"`);
                parseAndAddPoint(text);
            } catch (error) { updateOcrStatus(`OCR Error: ${error.message}`); }
        }

        function parseAndAddPoint(text) {
            // This regex handles numbers separated by a comma or any whitespace (including newlines).
            const match = text.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
            if (!match) return updateOcrStatus(`Recognized: "${text.trim()}" <br><b>Could not find valid coordinates.</b>`);
            const lat = parseFloat(match[1]), lng = parseFloat(match[2]);
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                 return updateOcrStatus(`Recognized: "${text.trim()}" <br><b>Parsed invalid lat/lng values.</b>`);
            }
            createAndAddPoint(lat, lng);
        }

        // --- Shared Map/Path Functions ---
        function createAndAddPoint(lat, lng) {
            const position = [lat, lng];
            const pointNumber = markers.length + 1;

            const numberIcon = L.divIcon({
                className: 'number-marker',
                html: `<span>${pointNumber}</span>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });

            const marker = L.marker(position, { icon: numberIcon })
                .addTo(map)
                .bindPopup(`Point ${pointNumber}: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            
            markers.push(marker);
            pathCoordinates.push(position);
            polyline.addLatLng(position);
            updatePointList(lat, lng);
            map.panTo(position);
        }

        function updatePointList(lat, lng) {
            const listUl = document.getElementById('point-list-ul');
            const listItem = document.createElement('li');
            listItem.className = 'text-gray-800';
            listItem.textContent = `${markers.length}. ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            listUl.prepend(listItem);
        }

        function clearMap() {
            stopTracking(); // Ensure any active tracking is stopped
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            pathCoordinates.length = 0;
            polyline.setLatLngs(pathCoordinates); // Clear the line by setting path to empty
            if (myLocationMarker) {
                map.removeLayer(myLocationMarker);
                myLocationMarker = null;
            }
            document.getElementById('point-list-ul').innerHTML = '';
            showMessage("Path has been cleared.", false);
        }
    </script>
</body>
</html>
